<!DOCTYPE html>
<html lang="en">

<head>
    <!-- Load d3.js, v4 -->
    <script src="https://d3js.org/d3.v6.js"></script>
</head>

<body>

    <!-- Visualization 1 -->
    <div id="meet"></div>

    <!-- Visualization 2 -->
    <div id="milestone"></div>

    <script>

        // VISUALIZATION 1 CODE
        // set the dimensions and margins of the graph
        var margin_1 = { top: 20, right: 20, bottom: 30, left: 60 },
            width_1 = 460,
            height_1 = 110;

        // load and format the data
        d3.csv("./Vis1_Data.csv",
            function (d) {
                //console.log("data", d);
                return { method: d.Method, "Same-sex": d.same_sex, "Large age difference": d.large_age_diff, "Interracial": d.interracial, "All": d.all }
            }).then(
                function (data) {
                    const smallMultiple = d3.select("#meet");

                    const meetColumns = ["Same-sex", "Large age difference", "Interracial", "All"]
                    meetColumns.forEach(coupleType => {
                        drawBarChartMeet(smallMultiple, coupleType, data, "Title");
                    })
                }
            )

        drawBarChartMeet = function (container, coupleType, data, chartTitle) {
            // append the svg object to the body of the page
            var svg = container.append("svg");
            svg.attr("width", width_1 + margin_1.left + margin_1.right)
            svg.attr("height", height_1 + margin_1.top + margin_1.bottom)
            svg.append("g")
                .attr("transform",
                    "translate(" + margin_1.left + "," + margin_1.top + ")");

            // Add X axis
            const xScale = d3.scaleBand()
                .domain(data.map(d => d.method))
                .range([0, width_1])
                .padding(0.2);

            svg.append("g")
                .attr("transform", "translate(0," + height_1 + ")")
                .call(d3.axisBottom(xScale))
                .selectAll("text")
                .attr("y", 10)
                .attr("x", 9)
                .attr("dy", ".35em")
                .attr("transform", "rotate(30)")
                .style("text-anchor", "start");

            // Add Y axis
            const yScale = d3.scaleLinear()
                .domain([0, 0.35])
                .range([height_1, 0]);

            svg.append("g")
                .call(d3.axisLeft(yScale))

            // add small multiple title
            svg.append("text")
                .attr("x", width_1 / 2)
                .attr("y", 16)
                .attr("text-anchor", "middle")
                .text(coupleType);

            // add x-axis title
            svg.append("text")
                .attr("x", width_1 / 2)
                .attr("y", height_1 - 5)
                .attr("text-anchor", "middle")
                .attr("font-size", "14px")
            // .text("Year");

            // add y-axis title, remember that all transformations are around the (0, 0) origin
            svg.append("text")
                .attr("x", -(margin_1.top + height_1 / 2))
                .attr("y", 15)
                .attr("transform", "rotate(-90)")  // rotate it by -90 degrees
                .attr("text-anchor", "middle")
                .attr("font-size", "14px")
            // .text("Proportion")

            // Add bars 
            const barGroup = svg.append("g") // create a group to keep the bars
                .attr("class", "barGroup")
                .attr("transform", `translate(${0}, ${0})`); // shift all bars by the margin offset

            // Add rectangles here by binding the totalPopDataEntries array with rect elements
            barGroup.selectAll("rect")
                .data(data)
                .join("rect")
                .attr("class", "path")
                .attr("class", d => d.method)
                .attr("x", d => xScale(d.method))
                .attr("fill", "#B3B1EF")
                .attr("y", d => yScale(d[coupleType]))
                .attr("width", xScale.bandwidth())
                .attr("height", d => height_1 - yScale(d[coupleType]))

                // .on("mouseover", function(data_, index_)  {
                //     d3.select(this).style("fill", "#696969");
                //     svg.selectAll('rect')
                //     .filter(function(d, i) {
                //         console.log("filtereing", index_)
                //         return i === index_
                //     })
                //     .style("fill", "#696969");
                    // svg.select("#tooltip-text").text(`${d[coupleType]} \nRating: ${d.rating}`);
                    // let positionOffest = 8;
                    // svg.select("#tooltip")
                    
                    //     // move the tooltip to where the cursor is
                    //     .attr("transform", `translate(${xScale(-1 * d.longitude) + positionOffest}, ${yScale(d.latitude) + positionOffest})`)
                    //     .style("display", "block");
                    // d3.selectAll("rect." + d.data.method)
                    //     .attr("stroke", "#333333")
                    //     .attr("stroke-width", 2);
                // })
                // .on("mouseout", function (event, d) {
                //     svg.select("#tooltip").style("display", "none");
                //     d3.select(this).attr("stroke", "none");
                // })

            /****** Tooltip Code ******/
            const tooltipGroup = svg.append("g")
                .attr("id", "tooltip")
                .style("display", "none")
                .append("text")
                .attr("id", "tooltip-text")
                .attr("x", 5)
                .attr("y", 15)
                .attr("font-size", "12px")
                .attr("font-weight", "bold")
                .attr("fill", "black");
        }

        // VISUALIZATION 2 CODE
        // set the dimensions and margins of the graph
        var margin = { top: 20, right: 20, bottom: 30, left: 60 },
            width = 460 - margin.left - margin.right,
            height = 400 - margin.top - margin.bottom;

        // append the svg object to the body of the page
        var svg = d3.select("#milestone")
            .append("svg")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
            .append("g")
            .attr("transform",
                "translate(" + margin.left + "," + margin.top + ")");
        // load and format the data
        d3.csv("./Vis2_Data.csv",
            function (d) {
                //console.log(d);
                return { month: d3.timeParse("%b")(d.date), value: d.Meet }
            }).then(
                function (data) {
                    // Add X axis
                    const x = d3.scaleTime()
                        .domain(d3.extent(data, d => d.month))
                        .range([0, width]);

                    svg.append("g")
                        .attr("transform", "translate(0," + height + ")")
                        .call(d3.axisBottom()
                            .tickFormat(d3.timeFormat("%b"))
                            .scale(x))

                    // Add Y axis
                    const y = d3.scaleLinear()
                        .domain([0, 500])
                        .range([height, 0]);

                    svg.append("g")
                        .call(d3.axisLeft(y));

                    // Add the line
                    svg.append("path")
                        .datum(data)
                        .attr("fill", "none")
                        .attr("stroke", "#69b3a2")
                        .attr("stroke-width", 1.5)
                        .attr("d", d3.line()
                            .x(d => x(d.month))
                            .y(d => y(d.value))
                        )

                    // Add the points
                    svg
                        .append("g")
                        .selectAll("dot")
                        .data(data)
                        .join("circle")
                        .attr("cx", d => x(d.month))
                        .attr("cy", d => y(d.value))
                        .attr("r", 5)
                        .attr("fill", "#69b3a2")
                }
            )


    </script>
</body>

</html>